<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Leitor de Cartão-Resposta</title>
<script async src="https://docs.opencv.org/4.x/opencv.js"></script>
<style>
  body{font-family:Arial;margin:20px}
  canvas{max-width:100%}
</style>
</head>
<body>

<h2>Leitor de Cartão-Resposta</h2>
<input type="file" id="fileInput" accept="image/*">

<br><br>
<canvas id="canvas"></canvas>

<pre id="output"></pre>

<script>
document.getElementById("fileInput").addEventListener("change", function(e){
    const file = e.target.files[0];
    if (!file) return;

    let img = new Image();
    img.onload = () => process(img);
    img.src = URL.createObjectURL(file);
});

function process(img){
    let canvas = document.getElementById("canvas");
    let ctx = canvas.getContext("2d");

    canvas.width = img.width;
    canvas.height = img.height;
    ctx.drawImage(img,0,0);

    // Carrega em Mat
    let src = cv.imread(canvas);
    let gray = new cv.Mat();
    cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);

    // Binarizar
    let th = new cv.Mat();
    cv.threshold(gray, th, 0, 255, cv.THRESH_BINARY_INV + cv.THRESH_OTSU);

    // --- CONFIGURAÇÃO DO CARTÃO ---
    const QUESTOES = 40;
    const ALTERNATIVAS = 4;

    // ÁREA onde ficam as bolhas (AJUSTAR FINALE SE QUISER)
    const xStart = img.width * 0.12; 
    const xEnd   = img.width * 0.88;
    const yStart = img.height * 0.32; 
    const yEnd   = img.height * 0.90;

    const colWidth = (xEnd - xStart) / 4;  
    const rowHeight = (yEnd - yStart) / (QUESTOES/4);

    let respostas = {};

    let q = 1;

    for (let col = 0; col < 4; col++){
        for (let linha = 0; linha < QUESTOES/4; linha++){
            
            // posição base da questão
            let baseX = xStart + col * colWidth;
            let baseY = yStart + linha * rowHeight;

            // 4 bolhas A/B/C/D
            let alternativas = ["A","B","C","D"];
            let preenchimentos = [];

            for (let a = 0; a < ALTERNATIVAS; a++){
                // bolha horizontalmente espaçada
                let bx = baseX + (a * (colWidth / 4));
                let by = baseY + rowHeight*0.4;

                let bw = colWidth/4.2;
                let bh = rowHeight*0.6;

                let roi = th.roi(new cv.Rect(bx, by, bw, bh));

                let preto = cv.countNonZero(roi);
                preenchimentos.push(preto);

                roi.delete();
            }

            // maior preenchimento = alternativa marcada
            let maxValue = Math.max(...preenchimentos);
            let idx = preenchimentos.indexOf(maxValue);

            // limiar mínimo pra considerar marcado
            if(maxValue < 150){  
                respostas[q] = "—"; // deixada em branco
            }else{
                respostas[q] = alternativas[idx];
            }
            q++;
        }
    }

    document.getElementById("output").textContent =
        JSON.stringify(respostas, null, 2);

    src.delete(); gray.delete(); th.delete();
}
</script>

</body>
</html>
